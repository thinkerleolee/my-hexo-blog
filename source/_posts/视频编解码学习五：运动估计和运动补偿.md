---
title: 视频编解码学习五：运动估计和运动补偿
date: 2019-02-02 16:30:07
tags:
    - 运动估计
    - 运动补偿
    - 视频编解码
    - 编解码
categories:
    - 音视频开发
mathjax: true
---

## 运动估计和运动补偿简介

在视频序列中，连续的帧间往往有着大量的相同信息，引起帧间误差的主要原因是帧内物体的运动，如图：

![TIM截图20190202162408.png](https://i.loli.net/2019/02/02/5c5553c87af75.png)

图中连续两帧之间（除字幕外），主要区别就是帧内物体（人物）的运动。此时，通过先前已编码帧的图像作为参考帧，对当前帧进行预测的过程称为**帧间预测**，帧间预测可以节省大量的图像存储空间。

### I、B、P帧的帧间预测

通常，图像帧是一组一组进行处理的。每组的第一帧(通常是第一帧)在编码的时候不使用运动估计的办法，这种帧称为**帧内编码帧(Intra frame)或者I帧**。该组中的其它帧使用帧间编码帧(Inter frame)，通常是**P帧**。这种编码方式通常被称为**IPPPP**，表示编码的时候第一帧是I帧，其它帧是P帧。

如图：

![TIM截图20190203182524.png](https://i.loli.net/2019/02/03/5c56c26a72838.png)

在进行预测的时候，不仅仅可以从过去的帧来预测当前帧，还可以使用未来的帧来预测当前帧。当然在编码的时候，未来的帧必须比当前帧更早的编码，也就是说，编码的顺序和播放的顺序是不同的。通常这样的当前帧是使用过去和未来的I帧或者P帧同时进行预测，被称为**双向预测帧**，即**B帧**。这种编码方式的编码顺序的一个例子为 IBBPBBPBBPBB。

如图：

![TIM截图20190203183341.png](https://i.loli.net/2019/02/03/5c56c3959b92b.png)

而**帧间预测**中所需要的两个主要技术就是**运动估计**和**运动补偿**，它们也是编码中重要的两个环节。

如图为H.264的编码流程图：

![TIM截图20190202130747.png](https://i.loli.net/2019/02/03/5c56d5b97dfe3.png)

## 基于块的运动补偿

**运动补偿(Motion Compensation)**，是一种描述相邻帧(相邻在这里表示在编码关系上相邻，在播放顺序上两帧未必相邻) 差别的方法，具体来说是描述前面一帧(相邻在这里表示在编码关系上的前面，在播放顺序上未必在当前帧前面)的每个小块怎样移动到当前帧中的某个位置去。

对分块运动补偿来说，运动矢量是模型的必要参数，必须一起编码加入码流中，而**运动估计**就是获得运动矢量的方法。


- 基于块的运动估计

    **运动估计(Motion Estimation)**,就是寻找视频序列中运动物体在前后帧图像之间变换的**运动矢量**（即运动的方向和大小），将运动矢量应用于图像以合成到下一图像的变换称为运动补偿。

    - 像素匹配

        在经典的运动估计中，对运动矢量的估计主要采用了基于块的像素匹配法。

        在基于块的像素匹配中，每一帧都被分解成固定大小的像素块（在MPEG中是16*16）作为匹配单元。

        如图，在两帧之间同样的16*16像素块有着位置的变化:

        ![TIM截图20190203184806.png](https://i.loli.net/2019/02/03/5c56c6f30b72a.png)

        在MPEG-4视频编码中，运动估计相当耗时，对编码的实时性影响很大。因此这里特别强调快速算法。运动估计方法主要有像素递归法和块匹配法两大类，前者复杂度很高，实际中应用较少，后者则在H.263和MPEG中广泛采用。在块匹配法中，重点研究块匹配准则及搜索方法。目前有三种常用的匹配准则：
        　　

        （1）绝对误差和（SAD, Sum of Absolute Difference）准则；


        （2）均方误差（MSE, Mean Square Error）准则；


        （3）归一化互相关函数（NCCF, Normalized Cross Correlation Function）准则。


        在上述三种准则中，SAD准则具有不需乘法运算、实现简单方便的优点而使用最多，但应清楚匹配准则的选用对匹配结果影响不大。

运动补偿通过**当前帧**和**参考帧**进行做差来形成一个**残差**,这个残差经过编码和变换，携带一些解码器所需要得信息输出到解码器。运动补偿在给定前一帧或未来帧的情况下预测当前帧。

一个稍微复杂一点的设计是估计一下整帧场景的移动和场景中物体的移动，并将这些运动通过一定的参数编码到码流中去。这样预测帧上的像素值就是由参考帧上具有一定位移的相应像素值而生成的。这样的方法比简单的相减可以获得能量更小的残差，从而获得更好的压缩比--当然，用来描述运动的参数不能在码流中占据太大的部分，否则就会抵消复杂的运动估计带来的好处。

视频解压缩的时候，只需保存运动矢量和残差数据就可以完全恢复出当前块。

参考：

[https://en.wikipedia.org/wiki/Motion_compensation](https://en.wikipedia.org/wiki/Motion_compensation)

《H.264中运动估计和运动补偿算法的优化与实现》李慧 - 北京邮电大学